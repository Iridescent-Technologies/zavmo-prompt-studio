name: Zavmo Prompt Studio — Smoke Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  smoke-test:
    name: Run Smoke Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run smoke tests
        run: node tests/smoke-test.js

      - name: Check total project size
        run: |
          TOTAL=0
          for f in index.html css/*.css js/*.js; do
            if [ -f "$f" ]; then
              S=$(stat --printf="%s" "$f")
              TOTAL=$((TOTAL + S))
            fi
          done
          TOTAL_KB=$((TOTAL / 1024))
          echo "Total project size: ${TOTAL_KB}KB (index.html + css/ + js/)"
          if [ "$TOTAL_KB" -gt 1024 ]; then
            echo "::notice::Total source is ${TOTAL_KB}KB"
          fi

      - name: Check for common issues
        run: |
          echo "Checking for console.log statements..."
          COUNT=$(grep -rc "console\.log" index.html js/ || true)
          TOTAL=$(echo "$COUNT" | awk -F: '{s+=$NF} END{print s+0}')
          if [ "$TOTAL" -gt 20 ]; then
            echo "::warning::Found $TOTAL console.log statements — consider removing debug logs"
          fi

          echo "Checking for TODO/FIXME comments..."
          TODOS=$(grep -rci "TODO\|FIXME\|HACK\|XXX" index.html js/ || true)
          TOTAL=$(echo "$TODOS" | awk -F: '{s+=$NF} END{print s+0}')
          if [ "$TOTAL" -gt 0 ]; then
            echo "::notice::Found $TOTAL TODO/FIXME comments"
            grep -rn "TODO\|FIXME\|HACK\|XXX" index.html js/ || true
          fi
